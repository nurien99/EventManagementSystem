@using Microsoft.AspNetCore.Components.Web
@using Microsoft.AspNetCore.Components.Authorization
@using EventManagementSystem.BlazorApp.Services
@namespace EventManagementSystem.BlazorApp.Components.Layout
@inherits LayoutComponentBase
@inject AuthenticationStateProvider AuthenticationStateProvider
@inject AuthService AuthService
@inject NavigationManager Navigation
@inject IJSRuntime JSRuntime

<CascadingAuthenticationState>
    <AuthorizeView>
        <NotAuthorized>
            <!-- Public Layout - Matching Authenticated Structure -->
            <div class="public-layout">
                <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
                    <div class="container-fluid">
                        <a class="navbar-brand" href="/">
                            <i class="bi bi-calendar-check me-2"></i>
                            Event Management System
                        </a>
                        <div class="navbar-nav ms-auto">
                            <a href="/login" class="btn btn-outline-light me-2">Sign In</a>
                            <a href="/register" class="btn btn-light">Sign Up</a>
                        </div>
                    </div>
                </nav>

                <!-- Main Content with proper container - matching authenticated layout -->
                <main class="main-content">
                    <div class="container-fluid">
                        @Body
                    </div>
                </main>
            </div>
        </NotAuthorized>
        <Authorized>
            <!-- Authenticated Layout -->
            <div class="authenticated-layout">
                <!-- Top Navigation Bar -->
                <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
                    <div class="container-fluid">
                        <!-- Brand -->
                        <a class="navbar-brand" href="/dashboard">
                            <i class="bi bi-calendar-check me-2"></i>
                            <span class="d-none d-md-inline">Event Management System</span>
                            <span class="d-md-none">EMS</span>
                        </a>

                        <!-- Mobile toggle -->
                        <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                            <span class="navbar-toggler-icon"></span>
                        </button>

                        <!-- Navigation Menu -->
                        <div class="collapse navbar-collapse" id="navbarNav">
                            <ul class="navbar-nav me-auto">
                                <li class="nav-item">
                                    <NavLink class="nav-link" href="/dashboard" Match="NavLinkMatch.All">
                                        <i class="bi bi-speedometer2 me-1"></i>Dashboard
                                    </NavLink>
                                </li>
                                
                                <li class="nav-item">
                                    <NavLink class="nav-link" href="/events">
                                        <i class="bi bi-search me-1"></i>Browse Events
                                    </NavLink>
                                </li>

                                <!-- My Events Dropdown for Organizers/Admins -->
                                <AuthorizeView Roles="EventOrganizer,Admin">
                                    <Authorized Context="organizerContext">
                                        <li class="nav-item dropdown">
                                            <a class="nav-link dropdown-toggle" href="#" id="myEventsDropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
                                                <i class="bi bi-calendar-event me-1"></i>My Events
                                            </a>
                                            <ul class="dropdown-menu">
                                                <li><a class="dropdown-item" href="/my-events"><i class="bi bi-list me-2"></i>All Events</a></li>
                                                <li><a class="dropdown-item" href="/create-event"><i class="bi bi-plus-circle me-2"></i>Create Event</a></li>
                                                <li><hr class="dropdown-divider"></li>
                                                <li><h6 class="dropdown-header">Event Management</h6></li>
                                                <li><a class="dropdown-item" href="#" onclick="showEventSelector('checkin')"><i class="bi bi-qr-code-scan me-2"></i>Check-In Scanner</a></li>
                                                <li><a class="dropdown-item" href="#" onclick="showEventSelector('assistants')"><i class="bi bi-people me-2"></i>Manage Assistants</a></li>
                                                <li><hr class="dropdown-divider"></li>
                                                <li><a class="dropdown-item" href="/analytics"><i class="bi bi-graph-up me-2"></i>Analytics</a></li>
                                            </ul>
                                        </li>
                                    </Authorized>
                                </AuthorizeView>

                                <li class="nav-item">
                                    <NavLink class="nav-link" href="/my-tickets">
                                        <i class="bi bi-ticket-perforated me-1"></i>My Tickets
                                    </NavLink>
                                </li>
                            </ul>

                            <!-- Right side navigation -->
                            <ul class="navbar-nav">
                                <!-- Create Event Button -->
                                <AuthorizeView Roles="EventOrganizer,Admin">
                                    <Authorized Context="createContext">
                                        <li class="nav-item d-none d-lg-block">
                                            <a href="/create-event" class="btn btn-success btn-sm me-2">
                                                <i class="bi bi-plus me-1"></i>Create Event
                                            </a>
                                        </li>
                                    </Authorized>
                                </AuthorizeView>

                                <!-- Admin Dropdown -->
                                <AuthorizeView Roles="Admin">
                                    <Authorized Context="adminContext">
                                        <li class="nav-item dropdown">
                                            <a class="nav-link dropdown-toggle admin-nav-link" href="#" id="adminDropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
                                                <i class="bi bi-shield-check me-1"></i>Admin
                                            </a>
                                            <ul class="dropdown-menu dropdown-menu-end">
                                                <li><h6 class="dropdown-header">Dashboard</h6></li>
                                                <li><a class="dropdown-item" href="/admin"><i class="bi bi-graph-up-arrow me-2"></i>Admin Overview</a></li>
                                                <li><hr class="dropdown-divider"></li>
                                                <li><h6 class="dropdown-header">Management</h6></li>
                                                <li><a class="dropdown-item" href="/admin/users"><i class="bi bi-people me-2"></i>User Management</a></li>
                                                <li><a class="dropdown-item" href="/admin/categories"><i class="bi bi-tags me-2"></i>Categories</a></li>
                                                <li><a class="dropdown-item" href="/admin/venues"><i class="bi bi-geo-alt me-2"></i>Venues</a></li>
                                            </ul>
                                        </li>
                                    </Authorized>
                                </AuthorizeView>

                                <!-- User Profile Dropdown -->
                                <li class="nav-item dropdown">
                                    <a class="nav-link dropdown-toggle" href="#" id="userDropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
                                        <i class="bi bi-person-circle me-1"></i>
                                        <span class="d-none d-lg-inline">@context.User.Identity?.Name</span>
                                    </a>
                                    <ul class="dropdown-menu dropdown-menu-end">
                                        <li><a class="dropdown-item" href="/profile"><i class="bi bi-person me-2"></i>Profile</a></li>
                                        <li><a class="dropdown-item" href="/settings"><i class="bi bi-gear me-2"></i>Settings</a></li>
                                        <li><a class="dropdown-item" href="/help"><i class="bi bi-question-circle me-2"></i>Help & Support</a></li>
                                        <li><hr class="dropdown-divider"></li>
                                        <li><button class="dropdown-item" @onclick="SignOut" disabled="@isLoggingOut">
                                            @if (isLoggingOut)
                                            {
                                                <span class="spinner-border spinner-border-sm me-2"></span>
                                                <span>Signing out...</span>
                                            }
                                            else
                                            {
                                                <i class="bi bi-box-arrow-right me-2"></i>
                                                <span>Logout</span>
                                            }
                                        </button></li>
                                    </ul>
                                </li>
                            </ul>
                        </div>
                    </div>
                </nav>

                <!-- Main Content with proper container -->
                <main class="main-content">
                    <div class="container-fluid">
                        @Body
                    </div>
                </main>
            </div>
        </Authorized>
    </AuthorizeView>
</CascadingAuthenticationState>

<div id="blazor-error-ui">
    <environment include="Staging,Production">
        An error has occurred. This application may no longer respond until reloaded.
    </environment>
    <environment include="Development">
        An unhandled exception has occurred. See browser dev tools for details.
    </environment>
    <a href="" class="reload">Reload</a>
    <a class="dismiss">🗙</a>
</div>

@code {
    private bool isLoggingOut = false;

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            try
            {
                // Initialize Bootstrap components
                await JSRuntime.InvokeVoidAsync("eval", @"
                    if (typeof bootstrap !== 'undefined') {
                        // Initialize all dropdowns
                        var dropdownElementList = [].slice.call(document.querySelectorAll('.dropdown-toggle'));
                        var dropdownList = dropdownElementList.map(function (dropdownToggleEl) {
                            return new bootstrap.Dropdown(dropdownToggleEl);
                        });
                        
                        // Initialize navbar collapse for mobile
                        var navbarToggler = document.querySelector('.navbar-toggler');
                        var navbarCollapse = document.querySelector('.navbar-collapse');
                        if (navbarToggler && navbarCollapse) {
                            new bootstrap.Collapse(navbarCollapse, {toggle: false});
                        }
                        
                        console.log('Bootstrap components initialized - Dropdowns:', dropdownList.length);
                    } else {
                        console.warn('Bootstrap is not loaded');
                    }
                ");
            }
            catch (Exception ex)
            {
                Console.WriteLine($"Error initializing dropdowns: {ex.Message}");
            }
        }
    }

    private async Task SignOut()
    {
        if (isLoggingOut) return;

        try
        {
            isLoggingOut = true;
            StateHasChanged();

            var logoutResult = await AuthService.LogoutAsync();

            if (logoutResult)
            {
                Navigation.NavigateTo("/");
            }
            else
            {
                Console.WriteLine("Warning: Logout may not have completed successfully");
                Navigation.NavigateTo("/");
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error during logout: {ex.Message}");
            Navigation.NavigateTo("/");
        }
        finally
        {
            isLoggingOut = false;
        }
    }
}